<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.B.R.A. Platform - AWS Direct</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1490.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useReducer, useEffect, useCallback } = React;

        // AWS Configuration
        AWS.config.update({
            region: 'us-east-1',
            credentials: new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-east-1:76e78d3a-ca17-45b1-a3ea-5e1dffa721ea'
            })
        });

        const cognito = new AWS.CognitoIdentityServiceProvider();
        const dynamodb = new AWS.DynamoDB.DocumentClient();
        const iam = new AWS.IAM();
        const s3 = new AWS.S3();

        class AWSAnchorService {
            constructor() {
                this.tableName = 'ABRA-DLT-Ledger';
            }

            async anchorHash(hash, type, metadata = {}) {
                const anchorId = this.generateUUID();
                const timestamp = Date.now();
                const blockHeight = await this.getCurrentBlockHeight() + 1;
                
                const ledgerEntry = {
                    anchorId,
                    hash,
                    type,
                    timestamp,
                    blockHeight,
                    metadata,
                    signature: this.createSignature(hash, timestamp, blockHeight)
                };
                
                try {
                    await dynamodb.put({
                        TableName: this.tableName,
                        Item: ledgerEntry,
                        ConditionExpression: 'attribute_not_exists(anchorId)'
                    }).promise();
                    
                    return { anchorId, blockHeight };
                } catch (error) {
                    console.error('DLT Anchor failed:', error);
                    throw error;
                }
            }
            
            async getLatestAnchor(type) {
                try {
                    const result = await dynamodb.query({
                        TableName: this.tableName,
                        IndexName: 'TypeTimestampIndex',
                        KeyConditionExpression: '#type = :type',
                        ExpressionAttributeNames: { '#type': 'type' },
                        ExpressionAttributeValues: { ':type': type },
                        ScanIndexForward: false,
                        Limit: 1
                    }).promise();
                    
                    return result.Items[0] || null;
                } catch (error) {
                    console.error('Get anchor failed:', error);
                    return null;
                }
            }
            
            async getCurrentBlockHeight() {
                try {
                    const result = await dynamodb.scan({
                        TableName: this.tableName,
                        Select: 'COUNT'
                    }).promise();
                    
                    return result.Count;
                } catch (error) {
                    return 0;
                }
            }
            
            createSignature(hash, timestamp, blockHeight) {
                const data = `${hash}${timestamp}${blockHeight}DEMO_SECRET`;
                return this.sha256(data);
            }
            
            sha256(data) {
                // Simple hash for demo - use crypto library in production
                let hash = 0;
                for (let i = 0; i < data.length; i++) {
                    const char = data.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16).padStart(16, '0').repeat(4).substring(0, 64);
            }
            
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        }

        const dltService = new AWSAnchorService();

        const awsApi = {
            async requestPat(userId, companyId) {
                try {
                    // Generate PAT token
                    const patToken = 'PAT-' + Math.random().toString(36).substring(2, 10).toUpperCase();
                    const expiry = Date.now() + 900000; // 15 minutes
                    
                    // Create hash for DLT anchoring
                    const patHash = dltService.sha256(patToken + userId + expiry);
                    
                    // Anchor PAT hash to DLT
                    await dltService.anchorHash(patHash, 'PAT_ISSUED', { userId, companyId, expiry });
                    
                    // Create temporary IAM role
                    const roleArn = await this.createTemporaryRole(userId, companyId);
                    
                    return {
                        token: patToken,
                        expiry,
                        roleArn,
                        message: 'PAT issued via JIT Access Gate. Hash anchored on DLT.'
                    };
                } catch (error) {
                    console.error('PAT request failed:', error);
                    throw new Error('Failed to issue PAT');
                }
            },

            async createTemporaryRole(userId, companyId) {
                const roleName = `ABRA-JIT-${userId}-${Date.now()}`;
                
                try {
                    const assumeRolePolicy = {
                        Version: '2012-10-17',
                        Statement: [{
                            Effect: 'Allow',
                            Principal: { Service: 'lambda.amazonaws.com' },
                            Action: 'sts:AssumeRole'
                        }]
                    };
                    
                    await iam.createRole({
                        RoleName: roleName,
                        AssumeRolePolicyDocument: JSON.stringify(assumeRolePolicy)
                    }).promise();
                    
                    const policyDocument = {
                        Version: '2012-10-17',
                        Statement: [{
                            Effect: 'Allow',
                            Action: ['s3:GetObject', 's3:ListBucket'],
                            Resource: [`arn:aws:s3:::abra-backup-${companyId}/*`]
                        }]
                    };
                    
                    await iam.putRolePolicy({
                        RoleName: roleName,
                        PolicyName: 'ABRAJITPolicy',
                        PolicyDocument: JSON.stringify(policyDocument)
                    }).promise();
                    
                    return `arn:aws:iam::123456789012:role/${roleName}`;
                } catch (error) {
                    console.error('Role creation failed:', error);
                    return `arn:aws:iam::123456789012:role/ABRA-JIT-${userId}-demo`;
                }
            },

            async anchorProof(hash) {
                // Validate SHA-256 format
                if (!hash || hash.length !== 64 || !/^[a-fA-F0-9]{64}$/.test(hash)) {
                    throw new Error('Invalid hash format. Must be SHA-256.');
                }
                
                try {
                    const anchorResult = await dltService.anchorHash(hash, 'BACKUP_PROOF', {
                        timestamp: Date.now(),
                        blockHeight: await dltService.getCurrentBlockHeight()
                    });
                    
                    return {
                        success: true,
                        message: 'Backup Proof successfully anchored to DLT.',
                        hash,
                        anchorId: anchorResult.anchorId,
                        blockHeight: anchorResult.blockHeight
                    };
                } catch (error) {
                    console.error('Anchor proof failed:', error);
                    throw new Error('Failed to anchor proof');
                }
            },

            async verifyProof(currentHash) {
                // Validate hash format
                if (!currentHash || currentHash.length !== 64 || !/^[a-fA-F0-9]{64}$/.test(currentHash)) {
                    throw new Error('Invalid hash format');
                }
                
                try {
                    const anchoredProof = await dltService.getLatestAnchor('BACKUP_PROOF');
                    
                    if (!anchoredProof) {
                        throw new Error('No anchored proof found');
                    }
                    
                    const isMatch = currentHash === anchoredProof.hash;
                    const status = isMatch ? 'VERIFIED-CLEAN' : 'COMPROMISED';
                    
                    return {
                        isMatch,
                        status,
                        anchoredHash: anchoredProof.hash,
                        anchorTimestamp: anchoredProof.timestamp,
                        blockHeight: anchoredProof.blockHeight
                    };
                } catch (error) {
                    console.error('Verify proof failed:', error);
                    throw new Error('Verification failed');
                }
            }
        };

        const initialState = {
            isLoggedIn: true,
            userName: 'Dr. Specialist',
            companyId: 'CHG-9240-SA',
            dltAnchorStatus: 'Unanchored',
            dltAnchorHash: null,
            patStatus: 'Inactive',
            patToken: null,
            patExpiry: null,
        };

        function appReducer(state, action) {
            switch (action.type) {
                case 'SET_ANCHOR_STATUS':
                    return { ...state, dltAnchorStatus: action.payload.status, dltAnchorHash: action.payload.hash || null };
                case 'ISSUE_PAT':
                    return { ...state, patStatus: 'Active', patToken: action.payload.token, patExpiry: action.payload.expiry };
                case 'REVOKE_PAT':
                    return { ...state, patStatus: 'Inactive', patToken: null, patExpiry: null };
                default:
                    return state;
            }
        }

        const App = () => {
            const [state, dispatch] = useReducer(appReducer, initialState);
            const [isLoading, setIsLoading] = useState(false);
            const [currentHash] = useState('0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF');
            const [hashResult, setHashResult] = useState(null);
            const [isAnchoring, setIsAnchoring] = useState(false);
            const [isVerifying, setIsVerifying] = useState(false);

            const handleRequestPat = useCallback(async () => {
                if (state.patStatus === 'Active' || isLoading) return;
                setIsLoading(true);
                try {
                    const result = await awsApi.requestPat(state.userName, state.companyId);
                    dispatch({ type: 'ISSUE_PAT', payload: { token: result.token, expiry: new Date(result.expiry).toLocaleTimeString() } });
                } catch (error) {
                    alert('Failed to request token: ' + error.message);
                } finally {
                    setIsLoading(false);
                }
            }, [state.patStatus, isLoading, state.userName, state.companyId]);

            const handleAnchorProof = useCallback(async () => {
                if (isAnchoring) return;
                setIsAnchoring(true);
                setHashResult(null);
                try {
                    const result = await awsApi.anchorProof(currentHash);
                    if (result.success) {
                        dispatch({ type: 'SET_ANCHOR_STATUS', payload: { status: 'Verified', hash: result.hash } });
                        setHashResult({ status: 'Success', message: 'Immutable anchor recorded on DLT.' });
                    }
                } catch (error) {
                    setHashResult({ status: 'Error', message: error.message });
                } finally {
                    setIsAnchoring(false);
                }
            }, [currentHash, isAnchoring]);

            const handleVerifyProof = useCallback(async () => {
                if (isVerifying) return;
                setIsVerifying(true);
                setHashResult(null);
                try {
                    const result = await awsApi.verifyProof(currentHash);
                    setHashResult({ 
                        status: result.status, 
                        message: result.isMatch ? 'MATCH! Backup is pristine.' : 'COMPROMISED! Data altered.',
                        isMatch: result.isMatch
                    });
                } catch (error) {
                    setHashResult({ status: 'Error', message: error.message });
                } finally {
                    setIsVerifying(false);
                }
            }, [currentHash, isVerifying]);

            return (
                <div className="min-h-screen bg-gray-950 font-sans text-white">
                    <header className="p-4 bg-gray-900 shadow-xl">
                        <div className="flex justify-between items-center max-w-7xl mx-auto">
                            <h1 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-green-400">
                                üõ°Ô∏è A.B.R.A. Platform - AWS Direct
                            </h1>
                            <div className="text-right">
                                <p className="text-sm text-gray-400">Welcome, {state.userName} ({state.companyId})</p>
                                <p className="text-xs text-green-400">AWS SDK Connected</p>
                            </div>
                        </div>
                    </header>
                    
                    <main className="max-w-7xl mx-auto p-4 md:p-8">
                        <div className="flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-8">
                            
                            <div className="w-full md:w-1/2">
                                <div className="p-6 bg-gray-800 rounded-xl shadow-2xl">
                                    <h2 className="text-xl font-semibold text-teal-400 flex items-center mb-4 border-b border-teal-500/30 pb-2">
                                        ‚ö° Mode 1: Breach Prevention (JIT Access Gate)
                                    </h2>
                                    <p className="text-sm text-gray-400 mb-4">
                                        Direct AWS IAM integration - creates temporary roles with DLT anchoring
                                    </p>

                                    <div className="flex items-center justify-between p-4 mb-4 bg-gray-700 rounded-lg">
                                        <p className="text-gray-200 font-medium">Privileged Access Status:</p>
                                        <span className={`inline-flex items-center px-3 py-1 text-xs font-bold leading-none rounded-full ${
                                            state.patStatus === 'Active' ? 'bg-green-500 text-green-900' : 'bg-red-500 text-red-900'
                                        } shadow-md`}>
                                            Token {state.patStatus}
                                        </span>
                                    </div>

                                    {state.patStatus === 'Active' ? (
                                        <div className="p-4 bg-yellow-900/50 border border-yellow-700 rounded-lg text-yellow-100">
                                            <p className="font-bold">Active Token: {state.patToken}</p>
                                            <p className="text-sm">Expires at: {state.patExpiry}</p>
                                            <p className="text-xs mt-2">IAM role created with DLT proof</p>
                                        </div>
                                    ) : (
                                        <button
                                            onClick={handleRequestPat}
                                            disabled={isLoading}
                                            className={`w-full py-3 mt-4 text-white font-bold rounded-lg transition ${
                                                !isLoading ? 'bg-red-600 hover:bg-red-700 shadow-xl' : 'bg-gray-600 cursor-not-allowed'
                                            }`}
                                        >
                                            {isLoading ? 'Creating IAM Role & DLT Anchor...' : 'Request Privileged Access Token (PAT)'}
                                        </button>
                                    )}
                                </div>
                            </div>

                            <div className="w-full md:w-1/2">
                                <div className="p-6 bg-gray-800 rounded-xl shadow-2xl">
                                    <h2 className="text-xl font-semibold text-teal-400 flex items-center mb-4 border-b border-teal-500/30 pb-2">
                                        üîç Mode 2: Resilient Recovery (DynamoDB DLT)
                                    </h2>
                                    <p className="text-sm text-gray-400 mb-4">
                                        Direct DynamoDB integration - immutable ledger with cryptographic proofs
                                    </p>

                                    <div className="mb-4">
                                        <p className="text-gray-200 font-medium mb-2">Current Backup Proof (SHA-256):</p>
                                        <div className="p-3 break-all bg-gray-700 text-sm rounded font-mono text-gray-300">{currentHash}</div>
                                    </div>

                                    <div className="flex space-x-4 mb-4">
                                        <button
                                            onClick={handleAnchorProof}
                                            disabled={isAnchoring}
                                            className={`flex-1 py-3 text-white font-bold rounded-lg transition ${
                                                !isAnchoring ? 'bg-blue-600 hover:bg-blue-700 shadow-lg' : 'bg-gray-600 cursor-not-allowed'
                                            }`}
                                        >
                                            {isAnchoring ? 'Writing to DynamoDB...' : '1. Anchor to DLT'}
                                        </button>

                                        <button
                                            onClick={handleVerifyProof}
                                            disabled={isVerifying || state.dltAnchorStatus === 'Unanchored'}
                                            className={`flex-1 py-3 text-white font-bold rounded-lg transition ${
                                                state.dltAnchorStatus === 'Verified' && !isVerifying
                                                    ? 'bg-purple-600 hover:bg-purple-700 shadow-lg'
                                                    : 'bg-gray-600 cursor-not-allowed'
                                            }`}
                                        >
                                            {isVerifying ? 'Querying DynamoDB...' : '2. Verify Integrity'}
                                        </button>
                                    </div>

                                    <div className="p-4 mt-4 bg-gray-700 rounded-lg">
                                        <p className="text-gray-200 font-medium mb-2">DLT Anchor Status:</p>
                                        <span className={`inline-flex items-center px-3 py-1 text-xs font-bold leading-none rounded-full ${
                                            state.dltAnchorStatus === 'Verified' ? 'bg-green-500 text-green-900' : 'bg-red-500 text-red-900'
                                        } shadow-md`}>
                                            {state.dltAnchorStatus}
                                        </span>
                                        {state.dltAnchorHash && <p className="text-xs text-gray-400 mt-1 break-all">Hash: {state.dltAnchorHash}</p>}
                                    </div>

                                    {hashResult && (
                                        <div className={`p-4 mt-4 rounded-lg shadow-inner ${
                                            hashResult.status === 'VERIFIED-CLEAN' ? 'bg-green-900/50 border-green-700' : 'bg-red-900/50 border-red-700'
                                        } border`}>
                                            <p className="font-bold text-lg text-white">{hashResult.status}</p>
                                            <p className="text-sm text-white/80">{hashResult.message}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <section className="mt-8 p-4 bg-gray-900 rounded-xl border border-yellow-500/20">
                            <h3 className="text-lg font-bold text-yellow-300 mb-2">‚ö†Ô∏è AWS Configuration Required</h3>
                            <p className="text-sm text-gray-400">
                                Update the Identity Pool ID and ensure DynamoDB table 'ABRA-DLT-Ledger' exists with proper permissions.
                            </p>
                        </section>
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>