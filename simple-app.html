<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.B.R.A. Platform</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useReducer, useEffect, useCallback } = React;

        const API_BASE_URL = 'http://localhost:3002';

        const api = {
            requestPat: async (user, companyId) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/request-pat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: user, companyId })
                    });
                    return response.json();
                } catch (error) {
                    return { token: 'PAT-DEMO123', expiry: Date.now() + 900000, message: 'Demo mode' };
                }
            },
            anchorProof: async (hash) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/anchor-proof`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hash })
                    });
                    return response.json();
                } catch (error) {
                    return { success: true, message: 'Demo anchored', hash };
                }
            },
            verifyProof: async (currentHash) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/verify-proof`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ currentHash })
                    });
                    return response.json();
                } catch (error) {
                    return { isMatch: true, status: 'VERIFIED-CLEAN', anchoredHash: currentHash };
                }
            }
        };

        const initialState = {
            isLoggedIn: true,
            userName: 'Dr. Specialist',
            companyId: 'CHG-9240-SA',
            dltAnchorStatus: 'Unanchored',
            dltAnchorHash: null,
            patStatus: 'Inactive',
            patToken: null,
            patExpiry: null,
        };

        function appReducer(state, action) {
            switch (action.type) {
                case 'SET_ANCHOR_STATUS':
                    return { ...state, dltAnchorStatus: action.payload.status, dltAnchorHash: action.payload.hash || null };
                case 'ISSUE_PAT':
                    return { ...state, patStatus: 'Active', patToken: action.payload.token, patExpiry: action.payload.expiry };
                case 'REVOKE_PAT':
                    return { ...state, patStatus: 'Inactive', patToken: null, patExpiry: null };
                default:
                    return state;
            }
        }

        const App = () => {
            const [state, dispatch] = useReducer(appReducer, initialState);
            const [isLoading, setIsLoading] = useState(false);
            const [currentHash] = useState('0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF');
            const [hashResult, setHashResult] = useState(null);
            const [isAnchoring, setIsAnchoring] = useState(false);
            const [isVerifying, setIsVerifying] = useState(false);

            const handleRequestPat = useCallback(async () => {
                if (state.patStatus === 'Active' || isLoading) return;
                setIsLoading(true);
                try {
                    const result = await api.requestPat(state.userName, state.companyId);
                    dispatch({ type: 'ISSUE_PAT', payload: { token: result.token, expiry: new Date(result.expiry).toLocaleTimeString() } });
                } catch (error) {
                    alert('Failed to request token.');
                } finally {
                    setIsLoading(false);
                }
            }, [state.patStatus, isLoading, state.userName, state.companyId]);

            const handleAnchorProof = useCallback(async () => {
                if (isAnchoring) return;
                setIsAnchoring(true);
                try {
                    const result = await api.anchorProof(currentHash);
                    if (result.success) {
                        dispatch({ type: 'SET_ANCHOR_STATUS', payload: { status: 'Verified', hash: result.hash } });
                        setHashResult({ status: 'Success', message: 'Immutable anchor recorded on DLT.' });
                    }
                } catch (error) {
                    setHashResult({ status: 'Error', message: error.message });
                } finally {
                    setIsAnchoring(false);
                }
            }, [currentHash, isAnchoring]);

            const handleVerifyProof = useCallback(async () => {
                if (isVerifying) return;
                setIsVerifying(true);
                try {
                    const result = await api.verifyProof(currentHash);
                    setHashResult({ 
                        status: result.status, 
                        message: result.isMatch ? 'MATCH! Backup is pristine.' : 'COMPROMISED! Data altered.',
                        isMatch: result.isMatch
                    });
                } catch (error) {
                    setHashResult({ status: 'Error', message: error.message });
                } finally {
                    setIsVerifying(false);
                }
            }, [currentHash, isVerifying]);

            return (
                <div className="min-h-screen bg-gray-950 font-sans text-white">
                    <header className="p-4 bg-gray-900 shadow-xl">
                        <div className="flex justify-between items-center max-w-7xl mx-auto">
                            <h1 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-green-400">
                                üõ°Ô∏è A.B.R.A. Cybersecurity Platform
                            </h1>
                            <div className="text-right">
                                <p className="text-sm text-gray-400">Welcome, {state.userName} ({state.companyId})</p>
                            </div>
                        </div>
                    </header>
                    
                    <main className="max-w-7xl mx-auto p-4 md:p-8">
                        <div className="flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-8">
                            
                            <div className="w-full md:w-1/2">
                                <div className="p-6 bg-gray-800 rounded-xl shadow-2xl">
                                    <h2 className="text-xl font-semibold text-teal-400 flex items-center mb-4 border-b border-teal-500/30 pb-2">
                                        ‚ö° Mode 1: Breach Prevention (JIT Access Gate)
                                    </h2>
                                    <p className="text-sm text-gray-400 mb-4">
                                        Addresses Governance Failure (MFA Gap) - enforces Just-In-Time access for privileged operations.
                                    </p>

                                    <div className="flex items-center justify-between p-4 mb-4 bg-gray-700 rounded-lg">
                                        <p className="text-gray-200 font-medium">Privileged Access Status:</p>
                                        <span className={`inline-flex items-center px-3 py-1 text-xs font-bold leading-none rounded-full ${
                                            state.patStatus === 'Active' ? 'bg-green-500 text-green-900' : 'bg-red-500 text-red-900'
                                        } shadow-md`}>
                                            Token {state.patStatus}
                                        </span>
                                    </div>

                                    {state.patStatus === 'Active' ? (
                                        <div className="p-4 bg-yellow-900/50 border border-yellow-700 rounded-lg text-yellow-100">
                                            <p className="font-bold">Active Token: {state.patToken}</p>
                                            <p className="text-sm">Expires at: {state.patExpiry}</p>
                                        </div>
                                    ) : (
                                        <button
                                            onClick={handleRequestPat}
                                            disabled={isLoading}
                                            className={`w-full py-3 mt-4 text-white font-bold rounded-lg transition ${
                                                !isLoading ? 'bg-red-600 hover:bg-red-700 shadow-xl' : 'bg-gray-600 cursor-not-allowed'
                                            }`}
                                        >
                                            {isLoading ? 'Requesting PAT via MFA...' : 'Request Privileged Access Token (PAT)'}
                                        </button>
                                    )}
                                </div>
                            </div>

                            <div className="w-full md:w-1/2">
                                <div className="p-6 bg-gray-800 rounded-xl shadow-2xl">
                                    <h2 className="text-xl font-semibold text-teal-400 flex items-center mb-4 border-b border-teal-500/30 pb-2">
                                        üîç Mode 2: Resilient Recovery (Integrity Anchor)
                                    </h2>
                                    <p className="text-sm text-gray-400 mb-4">
                                        Addresses BCP Failure/Backup Deletion - guarantees clean recovery post-attack.
                                    </p>

                                    <div className="mb-4">
                                        <p className="text-gray-200 font-medium mb-2">Current Backup Proof (SHA-256):</p>
                                        <div className="p-3 break-all bg-gray-700 text-sm rounded font-mono text-gray-300">{currentHash}</div>
                                    </div>

                                    <div className="flex space-x-4 mb-4">
                                        <button
                                            onClick={handleAnchorProof}
                                            disabled={isAnchoring}
                                            className={`flex-1 py-3 text-white font-bold rounded-lg transition ${
                                                !isAnchoring ? 'bg-blue-600 hover:bg-blue-700 shadow-lg' : 'bg-gray-600 cursor-not-allowed'
                                            }`}
                                        >
                                            {isAnchoring ? 'Anchoring...' : '1. Anchor Proof on DLT'}
                                        </button>

                                        <button
                                            onClick={handleVerifyProof}
                                            disabled={isVerifying || state.dltAnchorStatus === 'Unanchored'}
                                            className={`flex-1 py-3 text-white font-bold rounded-lg transition ${
                                                state.dltAnchorStatus === 'Verified' && !isVerifying
                                                    ? 'bg-purple-600 hover:bg-purple-700 shadow-lg'
                                                    : 'bg-gray-600 cursor-not-allowed'
                                            }`}
                                        >
                                            {isVerifying ? 'Verifying...' : '2. Verify Integrity Anchor'}
                                        </button>
                                    </div>

                                    <div className="p-4 mt-4 bg-gray-700 rounded-lg">
                                        <p className="text-gray-200 font-medium mb-2">DLT Anchor Status:</p>
                                        <span className={`inline-flex items-center px-3 py-1 text-xs font-bold leading-none rounded-full ${
                                            state.dltAnchorStatus === 'Verified' ? 'bg-green-500 text-green-900' : 'bg-red-500 text-red-900'
                                        } shadow-md`}>
                                            {state.dltAnchorStatus}
                                        </span>
                                    </div>

                                    {hashResult && (
                                        <div className={`p-4 mt-4 rounded-lg shadow-inner ${
                                            hashResult.status === 'VERIFIED-CLEAN' ? 'bg-green-900/50 border-green-700' : 'bg-red-900/50 border-red-700'
                                        } border`}>
                                            <p className="font-bold text-lg text-white">{hashResult.status === 'VERIFIED-CLEAN' ? 'VERIFIED-CLEAN' : 'RESULT'}</p>
                                            <p className="text-sm text-white/80">{hashResult.message}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>